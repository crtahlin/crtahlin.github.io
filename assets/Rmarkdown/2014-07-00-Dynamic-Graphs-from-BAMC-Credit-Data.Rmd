---
title: "Trying out dynamic graphs from BAMC credit data using plotly and ggvis packages"
#author: "Crt Ahlin"
#date: "25. 07. 2014"
output:
  html_document:
    toc: yes
---

I will look at two ways to generate dynamic graphs from the data scraped from the BAMC about "bad" credits. The first is the [plotly R package](https://plot.ly/r/) which uses the [ggplot2 package](http://ggplot2.org/) and extends it with some "dynamic" features. And the second is the freshly new and under development [ggvis R package](http://ggvis.rstudio.com/cookbook.html).


The following code scrapes the data form the website of BAMC and saves it into data frames. Prerequisites: load the function `getCreditData()` and the required libraries mentioned in the previous post. 
```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
# load the XML library
library(XML)

# function to get contract data from DUTB ####
getCreditData <- function(bank) {

if (bank=="NLB") {url <- "http://www.dutb.eu/si/o-nas/informacije-javnega-znacaja/pogodbe-nlb"}
if (bank=="NKBM") {url <- "http://www.dutb.eu/si/o-nas/informacije-javnega-znacaja/pogodbe-nkbm"}
  
html <- htmlTreeParse(url, useInternalNodes = TRUE)

# save all nodes that are in a table
nodes <- xpathSApply(html, "//tbody/tr/td[@*]",xmlValue)
# save the length (number) of nodes
numEntries <- length(nodes)

# save the data from the nodes to a data frame with named columns
data <- data.frame("ID"    = nodes[seq(from=1, to=numEntries, by=10)],
                   "Naziv" = nodes[seq(from=2, to=numEntries, by=10)],
                   "Sedez" = nodes[seq(from=3, to=numEntries, by=10)],
                   "Kreditodajalec" = nodes[seq(from=4, to=numEntries, by=10)],
                   "St.pogodbe" = nodes[seq(from=5, to=numEntries, by=10)],
                   "ZnesekEUR" = nodes[seq(from=6, to=numEntries, by=10)],
                   "Vrstaposla" = nodes[seq(from=7, to=numEntries, by=10)],
                   "Datumpogodbe" = nodes[seq(from=8, to=numEntries, by=10)],
                   "Vrstazavarovanja" = nodes[seq(from=9, to=numEntries, by=10)],
                   "Predmetzavaroavanja" = nodes[seq(from=10, to=numEntries, by=10)]
)

# transform variables into appropriate format
data[, "ZnesekEUR"] <- gsub(pattern="\\.", replacement = "", x=data[, "ZnesekEUR"])
data[, "ZnesekEUR"] <- gsub(pattern=",", replacement = "\\.", x=data[, "ZnesekEUR"])
data[, "ZnesekEUR"] <- as.numeric(data[, "ZnesekEUR"])
data[, "Datumpogodbe"] <- as.Date(data[, "Datumpogodbe"], format="%d.%m.%Y")

return(data)
}
```

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
library(plotly)
set_credentials_file(username="crtahlin", api_key="r9co8d5t4s")

```

```{r, results='hide'}
# get data from website
dataNLB <- getCreditData("NLB")
dataNKBM <- getCreditData("NKBM")
```

Let's try the plotly package. 


```{r, echo=TRUE, warning=FALSE}
library(plotly)
library(ggplot2)
library(scales)
# set the credentials (commented out beacase they are made up)
# set_credentials_file(username="username", api_key="99999999")
py <- plotly()

# function to get top x contracts by value ####
gettopContracts <- function (data, topN) {
  dataSubset <- head(data[order(data[,c("ZnesekEUR")], decreasing = TRUE),], topN) # top contracts dataset
  dataSubset <- dataSubset[!duplicated(dataSubset[,"St.pogodbe"]),] # remove duplicates of contract numbers
  return(dataSubset)
}

# helper function to format decimal separator ####
dot <- function(x) {gsub(pattern=",", replacement=".", x=as.character(comma(x, decimal.mark=",")))}

# get data for top N contracts
N <- 100
dataSubsetNLB <- gettopContracts(dataNLB, N)
dataSubsetNKBM <- gettopContracts(dataNKBM, N)

# plot NLB top contracts
ggPlot <- ggplot(data=dataSubsetNLB, aes(x=Naziv, y=ZnesekEUR)) + geom_bar(stat="identity") + theme_bw() +
  scale_x_discrete(limits=unique(dataSubsetNLB[,"Naziv"])) + scale_y_continuous(labels=dot) + 
  ggtitle(paste("Just an example plot (NLB)")) + theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(ggPlot) # print the "original" ggplot2

# Try to print a dynamic ggplot in plotly
# r <- py$ggplotly(ggPlot)
# r$response$url # go to this URL for the result
```
The ggplot2 "extension" does not seem to work as expected... The first time the plot [was weird][https://plot.ly/~crtahlin/2], now it doesn't finish in decent time. That's why above code is commented out. I won't spend more time on the plotly, but will rather invest it in ggvis package.


```{r, warning=FALSE, message=FALSE}
library(ggvis)

# drop levels that have no values from the data subset
dataSubsetNLB <- (droplevels(dataSubsetNLB))

# function to return the names of firms for the hover tooltip
firmNames <- function(x) {
  if(is.null(x)) return(NULL)
  paste0(x[1], collapse = "<br />")
}

# plot a ggvis graphic similar to the ggplot one; add a simple hover tooltip
dataSubsetNLB %>% ggvis(~Naziv, ~ZnesekEUR) %>% layer_bars() %>%
  add_axis("x",properties = axis_props(labels=list(angle=90, align="left")) ) %>% add_tooltip(firmNames, "hover")

```
It's relatively easy to make a plot comparable to ggplot2, with the added functionality of basic tooltip on mouse hover (not visible in blog post - I guess it maybe needs a running R session?). Except for adding the title of the plot, which seems not to be implemented yet :) Can't wait to see further development of the package.
